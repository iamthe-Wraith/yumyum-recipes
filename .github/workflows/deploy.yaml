name: Deploy to Production

on:
    repository_dispatch:
        types: [deploy_app]

jobs:
    deploy:
        runs-on: self-hosted

        steps:
            -
                name: Check out the repo
                uses: actions/checkout@v4

            - 
                name: Login to Docker Hub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKER_USERNAME }}
                    password: ${{ secrets.DOCKER_PASSWORD }}

            -
                name: Set environment variables
                run: |
                    echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
                    echo "JWT_SESSION_SECRET=${{ secrets.JWT_SESSION_SECRET }}" >> .env
                    echo "PUBLIC_APP_ENV=${{secrets.PUBLIC_APP_ENV}}" >> .env
                    echo "S3_ACCESS_KEY=${{secrets.S3_ACCESS_KEY}}" >> .env
                    echo "S3_BUCKET=${{secrets.S3_BUCKET}}" >> .env
                    echo "S3_ENDPOINT=${{secrets.S3_ENDPOINT}}" >> .env
                    echo "S3_REGION=${{secrets.S3_REGION}}" >> .env
                    echo "S3_SECRET_KEY=${{secrets.S3_SECRET_KEY}}" >> .env

            -
                run: docker compose down --rmi all --volumes --remove-orphans

            -
                run: docker compose up -d